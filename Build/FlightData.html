<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>Flight data visualization</title>
    <script src="../Build/Cesium/Cesium.js"></script>
    <script src="../Build/EventSource.js"></script>
    <script src="../Build/AngleIntegrator.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="../ThirdParty/jquery/dist/jquery.min.js"></script>
    <script src="../ThirdParty/jqueryui/jquery-ui.min.js"></script>
    <script src="../ThirdParty/togeojson/togeojson.js"></script>
    <style>
        @import url(../ThirdParty/jqueryui/jquery-ui.css);
        @import url(../Build/d3chart.css);
        @import url(../Build/Cesium/Widgets/widgets.css);
        html, body, #cesiumContainer {
            width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;
      }
        
        
    </style>
    
</head>

<body>
    <div id="cesiumContainer"></div>
    <div id="cesiumContainerGroundTrack">
        <span class="latitude">Latitude:</span>
        <span class="latitudeValue">67.8932469830635</span>
        <span class="longitude">Longitude:</span>
        <span class="longitudeValue">21.1068944441480</span>
    </div>
    <div id="controlPanel">
        <p>
            <button class="cesium-button" onclick="showAttitude()">Show attitude</button>
            <button class="cesium-button" onclick="showTrajectory()">Show trajectory</button>
        </p>
    </div>
    <div id="parameterVis">
        <p>
            <h1 style="color:#FFFFFF">Velocity</h1>
            <h1 style="color:#FFFFFF" id="velocity"></h1>
        </p> 
    </div>
    <div id="chart"></div>
    
    <script>
//        czml = [
//  {
//    "id":"document",
//    "name":"simple",
//    "version":"1.0",
//  },
//  {
//    "id":"9927edc4-e87a-4e1f-9b8b-0bfb3b05b227",
//    "name":"Accesses",
//    "description":"List of Accesses"
//  }
//        ]
        Cesium.BingMapsApi.defaultKey = 'AHktyWLXKe49Xq430Pnj~WpOSHCXoZA8C1sTcoYYfdA~AnGtg5pHMlY-dPZ7oCLACK3lDCAxuNDdWr69TuOLy2Ila2BNsKfWBAdixg12lWwR';
        var viewerGroundTrack = new Cesium.Viewer('cesiumContainerGroundTrack', {
            timeline : false,
            animation : false,
            selectionIndicator : false,
            infoBox: false,
            homeButton: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            geocoder: false,
            navigationInstructionsInitiallyVisible: false,
            baseLayerPicker: false,
            sceneMode: Cesium.SceneMode.SCENE2D,
            imageryProvider: new Cesium.createOpenStreetMapImageryProvider({
                url : 'https://a.tile.openstreetmap.org'
            })
        });
        var viewer = new Cesium.Viewer('cesiumContainer', {
            timeline : false,
            animation : false,
            selectionIndicator : false,
            infoBox: false,
            homeButton: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            geocoder: false,
            navigationInstructionsInitiallyVisible: false,
            baseLayerPicker: false
        });
        
        
        
        var scene = viewer.scene;
        
        // Get the camera
        var camera = viewer.camera;
        
        // Model used for the rocket, placeholder at the moment.
//        var modelURL = '../Build/3Dmodels/rocket.glb';
        var modelURL = '../Build/3Dmodels/Cesium_Air.glb';
        
        // The position of Esrange, which will be the initial position of the rocket.
        esrangeLong = 21.1068944441480;
        esrangeLat = 67.8932469830635;
        
        var height = 100;
        var position = Cesium.Cartesian3.fromDegrees(esrangeLong,esrangeLat,height);
        var heading = Cesium.Math.toRadians(-90);
        var pitch =  Cesium.Math.toRadians(0);
        var roll = 0;
        
        var hpr = new Cesium.HeadingPitchRoll(heading, pitch, roll);
        var orientation = Cesium.Transforms.headingPitchRollQuaternion(position, hpr);
       
        
        // Defining the model properties and adding it to the viewer
        var rocket = viewer.entities.add({
            name : 'Rocket',
            position: position,
            orientation: orientation,
            show : true,
            model: {
                uri : modelURL,
                minimumPixelSize : 16,
                maximumScale : 20000
            }
        });
        
        rocket2 = viewerGroundTrack.entities.add({
            name : 'Rocket2',
            position: rocket.position,
            orientation: rocket.orientation,
            show : rocket.show,
            model: rocket.model
        });
        
        viewerGroundTrack.trackedEntity = rocket2;
        viewerGroundTrack.flyTo(rocket2, {offset: new Cesium.HeadingPitchRange(0, 0, 750), duration: 10});
        
        // Create a billbord that will serve as background if it is desirable to only view the attitude
        bbBackgroundPos = Cesium.Cartesian3.fromDegrees(esrangeLong+0.001,esrangeLat,height);
        var bbBackground = viewer.entities.add({
            name : 'Billboard',
            position: bbBackgroundPos,
            billboard : {
                image : '../Source/Assets/Textures/bb-background.png', // default: undefined
                show : false, // default
                horizontalOrigin : Cesium.HorizontalOrigin.CENTER, // default
                verticalOrigin : Cesium.VerticalOrigin.CENTER, // default: CENTER
                scale : 2, // default: 1.0
                alignedAxis : Cesium.Cartesian3.ZERO, // default
//                width : 50*16, // default: undefined
//                height : 50*9 // default: undefined
            }
        });
       
        viewer.flyTo(rocket, new Cesium.HeadingPitchRange(0, 0, 100));
        viewer.trackedEntity = rocket;
        
      
        function showAttitude(){
            camera.cancelFlight();
            viewer.trackedEntity = undefined;
            scene.screenSpaceCameraController.enableInputs = false;
            bbBackground.billboard.show = true;
            viewer.camera.setView({
                destination : new Cesium.Cartesian3.fromDegrees(esrangeLong-0.002,esrangeLat,height),
                orientation: {
                    heading : Cesium.Math.toRadians(90.0), // east, default value is 0.0 (north)
                    pitch : Cesium.Math.toRadians(0),    // default value (looking down)
                    roll : 0.0                             // default value
                }
            });
        }
        
        function showTrajectory(){
            viewer.trackedEntity = rocket;
            scene.screenSpaceCameraController.enableInputs = true;
            bbBackground.billboard.show = false;
//            viewer.flyTo(rocket, new Cesium.HeadingPitchRange(0, 0, 200));
        }
        
        // Set latitude and longitude labels
        var miniCesium = d3.select("cesiumContainerGroundTrack");
        console.log(miniCesium)
        
        miniCesium.attr("width", 1000)
        .attr("height", 500)
        
        miniCesium.append("text")
        .attr("class", "altitude label")
        .attr("text-anchor", "start")
        .attr("y", 28)
        .attr("x", 30)
        .attr("transform", "translate(20," + 0 + ")")
        .text('Altitude: High as a kite');
        
//        var x;
//        var y;
//        var z;
//        var w;
        var w1;
        var w2;
        var w3;
        
        setInterval(function(){
//            w1 = Math.random()*0.1;
//            w2 = Math.random()*0.1;
//            w3 = Math.random()*0.1;
            w1 = 0.1;
            w2 = 0.1;
            w3 = 0.1;
            orientation = RK4(w1,w2,w3,orientation,0.1);
            rocket.orientation = orientation;
//            document.getElementById("velocity").innerHTML = Math.floor(100*Math.random()).toString();
        },10)
        
        
//        // STREAMING CODE
        var streaming = false;
        if(streaming){
            var czmlStream = new Cesium.CzmlDataSource();
            var czmlStreamUrl = 'http://localhost:8080/czml';

            // Setup EventSource
            var czmlEventSource = new EventSource(czmlStreamUrl);
            
            // Listen for EventSource data coming
            czmlEventSource.onmessage = function(e) {
                czmlStream.process(JSON.parse(e.data));            
            }
        
            // Put the datasource into Cesium
            viewer.dataSources.add(czmlStream);
        }
        
//        var kmlDataSource = new Cesium.KmlDataSource();
//        kmlDataSource.load('../sampleData/MASER13-trajectory.kml');
//        viewer.dataSources.add(kmlDataSource);
//        while(!viewer.dataSources.get(0).isLoading){};
//        console.log(kmlDataSource.entities.values);
        
    </script>
    <script type="text/javascript" src="d3chartAltPlot.js"></script>
</body>

</html>
